name: Continuous Deployment

# `azure/login@v2`
#   See: https://github.com/azure/login/tree/v2/
#
#   This workflow uses OpenID Connect (OIDC) federated identity credentials for authentication.
#   See DEPLOYMENT.md for detailed Azure App Registration configuration requirements.
#
#   Required: Configure a federated identity credential in Azure with subject claim:
#     repo:TheMagnificent11/mealie:ref:refs/heads/main
#
#   Repository Action Secrets:
#     AZURE__CLIENTID (Application ID from Microsoft Entra ID App Registration)
#     AZURE__TENANTID (Azure tenant ID)
#     AZURE__SUBSCRIPTIONID (Azure subscription ID)
#
#   Note: AZURE__CLIENTSECRET is NOT used - this workflow uses SERVICE_PRINCIPAL (OIDC) instead of client secrets

# `aspire deploy`
#   See: https://aspire.dev/reference/cli/commands/aspire-deploy/ & https://aspire.dev/get-started/deploy-first-app/?lang=csharp#deploy-your-app
#
#   Ensure `.aspire/settings.json` has `appHostPath` set to Aspire App Host csproj file to use for deployment
#
#   Repository Action Secrets (automatically read from secrets by Aspire CLI):
#     AZURE__SUBSCRIPTIONID (Azure subscription ID)
#     AZURE__RESOURCEGROUP (Azure resource group name for deployment)
#     AZURE__LOCATION (Azure region, e.g., eastus, westeurope)


on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.*

      - name: Install Aspire Workload
        run: dotnet workload install aspire

      - name: Install Aspire CLI
        run: dotnet tool install -g Aspire.Cli

      - name: Validate Aspire CLI Installation
        run: aspire --version

      - name: Azure Login
        uses: azure/login@v2
        with:
          auth-type: SERVICE_PRINCIPAL
          tenant-id: ${{ secrets.AZURE__TENANTID }}
          client-id: ${{ secrets.AZURE__CLIENTID }}
          subscription-id: ${{ secrets.AZURE__SUBSCRIPTIONID }}

      - name: Build
        run: dotnet build --configuration Release --nologo

      - name: Deploy Application
        run: |
          aspire deploy \
            --environment Production \
            --clear-cache \
            --include-exception-details
